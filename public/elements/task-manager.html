<link rel="import" href="../bower_components/polymer/polymer-element.html">
<link rel="import" href="../bower_components/polymerfire/firebase-auth.html">
<link rel="import" href="../bower_components/polymerfire/firebase-document.html">
<link rel="import" href="../bower_components/polymerfire/firebase-query.html">

<dom-module id="task-manager">
  <template>
  
    <firebase-auth user="{{user}}"></firebase-auth> 
    <firebase-query
      id="taskDB"
      path="/users/[[user.uid]]/tasks">
    </firebase-query>
    <firebase-query
      id="archiveDB"
      path="/users/[[user.uid]]/archived/tasks">
    </firebase-query>

  </template>

  <script>
    class TaskManager extends Polymer.Element {
      static get is() { return 'task-manager'; }

      static get properties() {
        return {
          user: Object
        }
      }

      complete(taskId) {
        var taskRef = this.$.taskDB.ref.child(taskId);
        var archiveRef = this.$.archiveDB.ref.child(taskId);
        var wasStarred = false;

        // we need to do three things:
        // 1. get the task in firebase & set its completedAt property
        // 2. copy its value data into the archive reference
        // 3. delete the task reference
        taskRef.once('value')
          .then( snap => {
            var task = snap.val();
            task.completedAt = Date.now();
            
            if (task.isStarred) {
              wasStarred = true;
            }

            archiveRef.set(task); })
          .then(() => taskRef.remove())
          .catch(error => console.log("ERROR archiving task: " + error.message));

        console.log("wasStarred? " + wasStarred);
      }
      
      updateProject(taskId, projectId) {
        var taskRef = this.$.taskDB.ref.child(taskId);

        taskRef.update({projectId: projectId})
          .catch(error => console.log("ERROR updating project: " + error.message));
      }

      setDue(taskId, dueAt) {
        var taskRef = this.$.taskDB.ref.child(taskId);

        taskRef.update({dueAt: dueAt, isActionable: true})
          .catch(error => console.log("ERROR setting due date: " + error.message));
      }

      star(taskId) {
        var taskRef = this.$.taskDB.ref.child(taskId);

        taskRef.update({isStarred: true, isActionable: true})
          .catch(error => console.log("ERROR starring: " + error.message));
      }
      
      unstar(taskId) {
        var taskRef = this.$.taskDB.ref.child(taskId);

        // unstar, but only unaction if task does not have a due date
        taskRef.once('value')
          .then( snap => {
            var task = snap.val();
            if (task.dueAt) {
              taskRef.update({isStarred: false});
            } else {
              taskRef.update({isStarred: false, isActionable: false});
            } })
          .catch(error => console.log("ERROR unstarring: " + error.message));
      }
    }

    window.customElements.define(TaskManager.is, TaskManager);
  </script>
</dom-module>
